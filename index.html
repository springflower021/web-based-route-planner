<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web based route planner</title>
    <!-- Include Leaflet CSS-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin="" />
    <!-- Include Leaflet JS-->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>
</head>
<style>
    html {
        height: 100%;
        overflow: hidden;
    }

    * {
        box-sizing: border-box;
    }

    body {
        background-color: rgb(176, 204, 217);
        height: 100%;
        margin: 0;
        padding: 0;
    }

    header {
        background-color: black;
        text-align: center;
        color: white;
        padding: 0.5%;
        height: 12%;
    }

    .footer {
        background-color: black;
        text-align: center;
        color: rgb(240, 227, 213);
        height: 10%;
    }

    a {
        /* Link*/
        color: white;
        padding: 10px;
    }

    .column.middle {
        float: left;
        width: 100%;
        height: 100%;
    }

    .column.side {
        float: left;
        width: 0%;
        height: 100%;
    }

    .row {
        height: 80%;
    }

    .row:after {
        content: "";
        display: table;
        clear: both;
    }

    #mapid {
        height: 100%;
    }
</style>
<body>
<header>
    <h2>Routenplaner</h2>
    <p></p>
    <h3>Yufeng Zhao & Paula Kostron </h3>
</header>
<div class="row">
    <div class="column side">&nbsp;</div>
    <div id="mapcolumn" class="column middle">
        <!-- map element-->
        <div id="mapid"></div>
    </div>
    <div class="column side">&nbsp; </div>
</div>
<div class="row">
    <div class="footer">
        <a><br>klick left mouse button to select the start <br> klick right mouse button to select the destination</a>



    </div>
</div>


<script>

        var initial_coordinates = [48.744945, 9.106736];
        var initial_zoom = 16;

        //Create map
        var map = L.map('mapid').setView(initial_coordinates, initial_zoom);
        //set tilelayer
        //L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        //    maxZoom: 18, minZoom: 6,
        //    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
        //        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        //        'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        //    id: 'mapbox.streets', //type of tiles
        //    accessToken: 'pk.eyJ1IjoiZWxmYWVuIiwiYSI6ImNqaTJ5eXAwZDBneGQzd2xnbzVsYzM1d3kifQ.unarZ5u6Otau9-WUD7neHA'
        //}).addTo(map);
        //L.tileLayer('https://tile.openstreetmap.org/${z}/${x}/${y}.png', { }).addTo(map);
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);

        map.on('click', onMapClick);
        map.on('contextmenu', onMapRightClick);

        //Initialize markers
        var ziel_marker = L.marker(initial_coordinates, { title: "destination" }).addTo(map);
        ziel_marker.bindPopup("destination <br> latitude: " + ziel_marker.getLatLng().lat + "<br>longitude: " + ziel_marker.getLatLng().lng);
        ziel_marker.on('mouseover', onMarkerMouseOver2);
        ziel_marker.on('mouseout', onMarkerMouseOut2);

        var start_marker = L.marker(initial_coordinates, { title: "start" }).addTo(map);
        start_marker.bindPopup("start <br> latitude: " + start_marker.getLatLng().lat + "<br>longitude: " + start_marker.getLatLng().lng);
        start_marker.on('mouseover', onMarkerMouseOver);
        start_marker.on('mouseout', onMarkerMouseOut);

        var myLayer = L.geoJSON().addTo(map); // empty geoJSON layer
        myLayer.setStyle({ color: "black" });  //setting color

        var current_request = "";

        function queryPath() {

            myLayer.remove();
            myLayer = L.geoJSON().addTo(map); // empty geoJSON layer

            var path = './request/'; //relative path
            var coord1 = start_marker.getLatLng().lng + "&" + start_marker.getLatLng().lat;
            var coord2 = ziel_marker.getLatLng().lng + "&" + ziel_marker.getLatLng().lat;
            current_request = coord1 + '&' + coord2;
            var query = path + current_request;

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    //Process response
                    var d = JSON.parse(this.responseText);
                    testLines = [{
                        "type": d.type,
                        "coordinates": d.coordinates
                    }]
                    //console.log("type : " + d.type)

                    //Filter out old requests
                    var current_req = current_request.split("&");
                    const accuracy = 100;
                    var start_lng_equal = Math.round(d.coordinates[0][0]*accuracy) == Math.round(current_req[0]*accuracy);
                    var start_lat_equal = Math.round(d.coordinates[0][1]*accuracy) == Math.round(current_req[1]*accuracy);
                    var ziel_lng_equal = Math.round(d.coordinates[d.coordinates.length - 1][0]*accuracy) == Math.round(current_req[2]*accuracy);
                    var ziel_lat_equal = Math.round(d.coordinates[d.coordinates.length - 1][1]*accuracy) == Math.round(current_req[3]*accuracy);
                    var req_is_current = start_lng_equal && start_lat_equal && ziel_lng_equal && ziel_lat_equal;
                    if (req_is_current) {
                        myLayer.addData(testLines);
                        myLayer.setStyle({ color: "black" });  //set color
                    }



                }
            };
            if (query != null && query != "") {
                //send request
                xhttp.open("GET", query, true);
                xhttp.send();
            }
        }

        function queryNearest(marker, type, long, lat) {
            var path = './requestNearest/'; //relative path
            var coord = long + "&" + lat;
            var query = path + coord;

            var point = "";
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    //Process response
                    var data = JSON.parse(this.responseText);
                    point = {
                        "type": data.type,
                        "coordinates": data.coordinates
                    }
                    console.log("type : " + data.type);
                    marker.setLatLng([point.coordinates[1], point.coordinates[0]]);

                    marker.setPopupContent(type + "<br> Latitude: " + marker.getLatLng().lat + "<br>Longitude: " + marker.getLatLng().lng);
                    queryPath();

                }
            };
            if (query != null && query != "") {
                //send request
                xhttp.open("GET", query, true);
                xhttp.send();
            }
        }

        function onMapClick(e) {
            //Update start_marker
            start_marker.setLatLng(e.latlng);
            queryNearest(start_marker, "Start", start_marker.getLatLng().lng, start_marker.getLatLng().lat);
        }
        function onMarkerMouseOver(e) {
            start_marker.openPopup();
        }

        function onMarkerMouseOut(e) {
            start_marker.closePopup();
        }

        function onMapRightClick(e) {
            //Update ziel_marker
            ziel_marker.setLatLng(e.latlng);
            queryNearest(ziel_marker, "Ziel", ziel_marker.getLatLng().lng, ziel_marker.getLatLng().lat);
        }
        function onMarkerMouseOver2(e) {
            ziel_marker.openPopup();
        }

        function onMarkerMouseOut2(e) {
            ziel_marker.closePopup();
        }

    </script>
</body>
</html>